{% extends "base.html" %}
{% block title %}Edit Alert{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">

    <div class="mb-4">
      <h2 class="fw-bold mb-1">Edit Alert</h2>
      <p class="text-secondary mb-0">Modify alert configuration</p>
    </div>

    <form method="POST">

      <!-- Alert Rule -->
      <div class="card mb-4">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0 fw-bold">Alert Rule</h5>
        </div>
        <div class="card-body p-4">

          <div class="mb-3">
            <label class="form-label text-secondary fw-semibold">Alert Name</label>
            <input type="text" name="name" class="form-control" value="{{ alert.name }}" required>
          </div>

          <div class="mb-3">
            <label class="form-label text-secondary fw-semibold">Keyword</label>
            <input type="text" name="keyword" class="form-control" value="{{ alert.keyword }}" required>
          </div>

          <div class="mb-3">
            <label class="form-label text-secondary fw-semibold">Interval (minutes)</label>
            <input type="number" name="interval_minutes" class="form-control" value="{{ alert.interval_minutes }}"
              required>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="enabled" name="enabled" {% if alert.enabled %}checked{%
              endif %}>
            <label class="form-check-label" for="enabled">Enabled</label>
          </div>

        </div>
      </div>

      <!-- EMAIL ACTION -->
      <div class="card mb-4">
        <div class="card-header bg-white py-3 fw-bold">
          <div class="form-check m-0">
            <input class="form-check-input me-2" type="checkbox" id="email_action" name="email_action" {% if
              email_action %}checked{% endif %}>
            <label class="form-check-label" for="email_action">Email Alert</label>
          </div>
        </div>

        <div id="emailConfig" class="card-body p-4 {% if not email_action %}d-none{% endif %}">

          <div class="mb-3">
            <label class="form-label text-secondary fw-semibold">Recipients</label>
            <input class="form-control" name="email_to" placeholder="Recipients"
              value="{{ email_action.config.get('to', []) | join(',') if email_action }}">
          </div>

          <div class="mb-3">
            <label class="form-label text-secondary fw-semibold">Subject</label>
            <input class="form-control" name="email_subject" placeholder="Subject"
              value="{{ email_action.config.get('subject', '') if email_action }}">
          </div>

          <div class="mb-3">
            <label class="form-label text-secondary fw-semibold">Body</label>
            <textarea class="form-control" name="email_body"
              rows="3">{{ email_action.config.get('body', '') if email_action }}</textarea>
          </div>

          <div class="mb-3">
            <label class="form-label text-secondary fw-semibold">Importance</label>
            <select name="email_importance" class="form-select">
              <option value="normal" {% if email_action and email_action.config.get('importance','normal')=="normal"
                %}selected{% endif %}>
                Normal
              </option>
              <option value="high" {% if email_action and email_action.config.get('importance','')=="high" %}selected{%
                endif %}>
                High
              </option>
              <option value="low" {% if email_action and email_action.config.get('importance','')=="low" %}selected{%
                endif %}>
                Low
              </option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label text-secondary fw-semibold">Throttle Interval (minutes)</label>
            <input type="number" name="email_throttle" class="form-control" min="1"
              value="{{ email_action.config.get('throttle_minutes', 5) if email_action else 5 }}">
          </div>

          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="email_include_log" id="email_include_log" {% if
              email_action and email_action.config.get('include_log', False) %}checked{% endif %}>
            <label class="form-check-label" for="email_include_log">
              Include matched log details in email (timestamp, message)
            </label>
          </div>

        </div>
      </div>

      <!-- SERVICENOW ACTION -->
      <div class="card mb-4">
        <div class="card-header bg-white py-3 fw-bold">
          <div class="form-check m-0">
            <input class="form-check-input me-2" type="checkbox" id="sn_action" name="sn_action" {% if sn_action
              %}checked{% endif %}>
            <label class="form-check-label" for="sn_action">ServiceNow Incident</label>
          </div>
        </div>

        <div id="snConfig" class="card-body p-4 {% if not sn_action %}d-none{% endif %}">

          <div class="mb-3">
            <label class="form-label text-secondary fw-semibold">Priority</label>
            <select name="sn_priority" class="form-select">
              {% for p in ["1","2","3","4"] %}
              <option value="{{p}}" {% if sn_action and sn_action.config.get('priority','')==p %}selected{% endif %}>
                P{{p}}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label text-secondary fw-semibold">Short Description</label>
            <input class="form-control" name="sn_short_desc" placeholder="Short description"
              value="{{ sn_action.config.get('short_description','') if sn_action }}">
          </div>

          <div class="mb-3">
            <label class="form-label text-secondary fw-semibold">Description</label>
            <textarea class="form-control" name="sn_description"
              rows="3">{{ sn_action.config.get('description','') if sn_action }}</textarea>
          </div>

          <div class="mb-3">
            <label class="form-label text-secondary fw-semibold">Throttle Interval (minutes)</label>
            <input type="number" name="sn_throttle" class="form-control" min="1"
              value="{{ sn_action.config.get('throttle_minutes', 5) if sn_action else 5 }}">
          </div>

          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="sn_include_log" id="sn_include_log" {% if sn_action
              and sn_action.config.get('include_log', False) %}checked{% endif %}>
            <label class="form-check-label" for="sn_include_log">
              Include matched log details in incident (timestamp, message)
            </label>
          </div>

        </div>
      </div>


      <div class="text-end mb-5">
        <a href="{{ url_for('alerts.list_alerts') }}" class="btn btn-outline-secondary me-2">Cancel</a>
        <button class="btn btn-primary px-4">Save Changes</button>
      </div>

    </form>

  </div>
</div>
{% endblock %}

{% block scripts %}

<script>
  // Email Action Toggle
  document.getElementById("email_action").addEventListener("change", e => {
    document.getElementById("emailConfig").classList.toggle("d-none", !e.target.checked);

    // Auto-check ServiceNow if Email is selected
    if (e.target.checked) {
      const snInput = document.getElementById("sn_action");
      if (!snInput.checked) {
        snInput.checked = true;
        document.getElementById("snConfig").classList.remove("d-none");
      }
    }
  });

  // ServiceNow Action Toggle
  document.getElementById("sn_action").addEventListener("change", e => {
    document.getElementById("snConfig").classList.toggle("d-none", !e.target.checked);
  });
</script>
{% endblock %}